<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>For Line 🌿</title>
  <meta name="description" content="A private little journey" />
  <style>
    /* ---------- Color system ---------- */
    :root{
      --bg: #FAF9F6;            /* warm ivory */
      --surface: #F1E4D3;       /* cream beige */
      --primary: #5B9071;       /* base green */
      --primary-dark:#447A5B;   /* hover/depth */
      --secondary:#F3CFC6;      /* soft blush */
      --accent:#D8B384;         /* muted gold */
      --ink:#2E2E2E;            /* text */
      --ok:#3aa96e;
      --err:#d94c4c;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink); background: linear-gradient(135deg, #ffe6f2 0%, var(--bg) 40%, #ffe8cc 100%);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }

    /* Subtle floating particles */
    .ambient{position:fixed; inset:0; pointer-events:none; z-index:0}

    /* Card */
    .card{
      position:relative; z-index:1;
      width:min(820px, 92vw); min-height:380px;
      background:rgba(255,255,255,.7);
      backdrop-filter:saturate(1.2) blur(8px);
      border:1px solid rgba(0,0,0,.06);
      border-radius:24px; box-shadow:0 10px 40px rgba(0,0,0,.08);
      padding:28px 28px 22px; overflow:hidden;
    }

    header{display:flex; align-items:center; gap:12px; margin-bottom:6px}
    header .dot{width:10px; height:10px; border-radius:50%; background:var(--primary)}
    header h1{font-size:1.1rem; font-weight:600; letter-spacing:.3px; margin:0; color:#40594b}

    .view{display:none; opacity:0; transform:translateY(12px); transition:opacity .5s ease, transform .5s ease}
    .view.active{display:block; opacity:1; transform:none}

    .welcome{display:grid; gap:18px; place-items:center; text-align:center; padding:28px}
    .welcome h2{font-size:2.2rem; color:var(--primary); margin:8px 0 0}
    .welcome p{max-width:52ch; line-height:1.45; margin:0}

    .password-wrap{display:flex; gap:10px; margin-top:6px; flex-wrap:wrap; justify-content:center}
    input[type=password]{
      padding:12px 14px; font-size:1rem; border-radius:12px; border:1px solid rgba(0,0,0,.12);
      min-width:240px; background:#fff;
    }
    .btn{appearance:none; border:none; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer}
    .btn.primary{background:var(--primary); color:#fff}
    .btn.primary:hover{background:var(--primary-dark)}
    .btn.ghost{background:transparent; color:var(--primary); border:1px solid var(--primary)}

    .hint{font-size:.92rem; color:#6b6b6b}
    .err{color:var(--err); margin-top:8px; min-height:1.2em}

    /* Journey */
    .journey{display:grid; grid-template-rows:auto 1fr auto; height:100%;}
    .slide{
      display:grid; grid-template-columns: 1.1fr 1fr; gap:22px; align-items:center; padding:8px 6px 2px;
    }
    .media{width:100%; aspect-ratio: 4/3; background:var(--surface); border-radius:16px; overflow:hidden;
      box-shadow:0 8px 26px rgba(0,0,0,.08); border:1px solid rgba(0,0,0,.06)
    }
    .media img{width:100%; height:100%; object-fit:cover; display:block}
    .copy h3{margin:.2rem 0 .4rem; color:var(--primary)}
    .copy p{margin:.25rem 0; line-height:1.5}

    nav.controls{display:flex; justify-content:space-between; gap:10px; margin-top:16px}
    .step{display:flex; gap:6px; align-items:center; font-size:.95rem; color:#666}

    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:rgba(91,144,113,.1); color:#2b5944; font-weight:600; font-size:.9rem}

    /* Mobile */
    @media (max-width: 820px){
      .slide{grid-template-columns:1fr;}
    }

    /* Fade choreography */
    .fade-in{animation:fadeIn .55s ease both}
    .fade-out{animation:fadeOut .45s ease both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none}}
    @keyframes fadeOut{from{opacity:1} to{opacity:0; transform:translateY(-10px)}}

    /* Admin encryptor (only when ?admin=1) */
    .admin{display:none}
    .admin.active{display:block; position:fixed; inset:auto 16px 16px 16px; z-index:5; background:#fff; border:1px solid rgba(0,0,0,.1); border-radius:14px; box-shadow:0 16px 44px rgba(0,0,0,.14); padding:14px}
    .admin textarea{width:100%; min-height:140px}
  </style>
</head>
<body>
  <!-- Ambient canvas -->
  <canvas class="ambient" id="ambient"></canvas>

  <main class="card" role="main" aria-live="polite">
    <header>
      <span class="dot" aria-hidden="true"></span>
      <h1>For Line</h1>
      <span class="pill" style="margin-left:auto">Private</span>
    </header>

    <!-- View: Welcome / Password -->
    <section id="welcome" class="view active welcome" aria-labelledby="welcome-title">
      <h2 id="welcome-title">Hi Line 🌸</h2>
      <p>I made you a small, private journey. I’ll give you a password in person. When you’re ready, enter it below.</p>
      <div class="password-wrap">
        <label class="sr" for="pw">Password</label>
        <input id="pw" type="password" inputmode="text" autocomplete="off" placeholder="Password" />
        <button id="unlock" class="btn primary">Continue</button>
      </div>
      <div id="err" class="err" aria-live="polite"></div>
      <p class="hint">This page is for you only. ✨</p>
    </section>

    <!-- View: Journey (filled after decrypt) -->
    <section id="journey" class="view" aria-live="polite"></section>
  </main>

  <!-- Admin encryptor (open with ?admin=1) -->
  <section id="admin" class="admin" aria-label="Encrypt content">
    <h3 style="margin:.2rem 0 .6rem;color:#444">Admin: Encrypt content to paste as CIPHERTEXT_B64</h3>
    <p style="margin:.2rem 0 .6rem;color:#666">Paste your JSON (slides array) and the password. Click <em>Encrypt</em>, then copy the Base64 into the constant in this file.</p>
    <textarea id="plainJson" placeholder='[
  {"title":"Title","text":"Paragraph...","img":"images/photo1.jpg"},
  {"title":"Another","text":"..."}
]'></textarea>
    <div style="display:flex; gap:8px; margin:8px 0">
      <input id="adminPw" type="password" placeholder="Password" style="flex:1; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,.12)" />
      <button id="doEncrypt" class="btn ghost">Encrypt</button>
    </div>
    <textarea id="outCipher" placeholder="Ciphertext Base64 will appear here"></textarea>
  </section>

  <script>
    // -------------------- Minimal ambient particles --------------------
    (function(){
      const c = document.getElementById('ambient');
      const ctx = c.getContext('2d');
      const parts = Array.from({length: 32}, () => ({
        x: Math.random(), y: Math.random(), r: Math.random()*2+0.6, s: Math.random()*0.3+0.05,
      }));
      function resize(){ c.width = innerWidth; c.height = innerHeight; }
      addEventListener('resize', resize, {passive:true}); resize();
      (function loop(){
        ctx.clearRect(0,0,c.width,c.height);
        parts.forEach(p=>{ p.y += p.s/180; if(p.y>1) p.y=0; });
        ctx.save();
        parts.forEach((p,i)=>{
          const x = p.x*c.width, y = p.y*c.height;
          ctx.globalAlpha = 0.08 + (i%5)/50; ctx.fillStyle = i%2? '#5B9071' : '#F3CFC6';
          ctx.beginPath(); ctx.arc(x,y,p.r*6,0,Math.PI*2); ctx.fill();
        });
        ctx.restore(); requestAnimationFrame(loop);
      })();
    })();

    // -------------------- Crypto helpers (AES-GCM + PBKDF2) --------------------
    const CIPHERTEXT_B64 = ""; // <-- paste output from Admin Encryptor here
    // If empty, we fall back to a tiny demo dataset with password "demo" (not sensitive)

    async function sha256Hex(str){
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function deriveKey(password, salt){
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey({ name: 'PBKDF2', salt, iterations: 120000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt','decrypt']);
    }

    function b64ToBytes(b64){ return Uint8Array.from(atob(b64), c=>c.charCodeAt(0)); }
    function bytesToB64(arr){ return btoa(String.fromCharCode(...arr)); }

    async function encryptJSON(jsonStr, password){
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv   = crypto.getRandomValues(new Uint8Array(12));
      const key  = await deriveKey(password, salt);
      const pt   = new TextEncoder().encode(jsonStr);
      const ct   = new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, pt));
      const joined = new Uint8Array(salt.length + iv.length + ct.length);
      joined.set(salt, 0); joined.set(iv, salt.length); joined.set(ct, salt.length+iv.length);
      return bytesToB64(joined);
    }

    async function decryptJSON(b64, password){
      const data = b64ToBytes(b64);
      const salt = data.slice(0,16);
      const iv   = data.slice(16,28);
      const ct   = data.slice(28);
      const key  = await deriveKey(password, salt);
      const pt   = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
      return new TextDecoder().decode(pt);
    }

    // -------------------- Views & flow --------------------
    const $ = sel => document.querySelector(sel);
    const welcome = $('#welcome');
    const journey = $('#journey');
    const err = $('#err');

    $('#unlock').addEventListener('click', unlock);
    $('#pw').addEventListener('keydown', e=>{ if(e.key==='Enter') unlock(); });

    function swap(toShow){
      const active = document.querySelector('.view.active');
      if(active){ active.classList.remove('active'); active.classList.add('fade-out'); setTimeout(()=>{ active.style.display='none'; active.classList.remove('fade-out'); }, 450); }
      toShow.style.display='block';
      requestAnimationFrame(()=>{ toShow.classList.add('active','fade-in'); setTimeout(()=>toShow.classList.remove('fade-in'), 550); });
    }

    async function unlock(){
      err.textContent = '';
      const pw = $('#pw').value.trim(); if(!pw){ err.textContent = 'Please enter the password'; return; }
      try{
        let slides;
        if(CIPHERTEXT_B64){
          const json = await decryptJSON(CIPHERTEXT_B64, pw);
          slides = JSON.parse(json);
        } else {
          // Demo content (password: demo)
          if(pw !== 'demo') throw new Error('Wrong password');
          slides = [
            {title:'Hi Line ✨', text:'This is a private journey made with love. (Demo data)'} ,
            {title:'A memory', text:'Add a photo and a short memory here. (Demo data)'} ,
            {title:'More to come', text:'Replace this demo by encrypting your real content with the Admin tool.'}
          ];
        }
        renderJourney(slides);
        swap(journey);
        $('#pw').value='';
      }catch(e){ err.textContent = 'Wrong password. Try again ❤️'; }
    }

    function el(tag, props={}, children=[]){ const d=document.createElement(tag); Object.assign(d, props); children.forEach(c=>d.append(c)); return d; }

    function renderJourney(slides){
      journey.innerHTML = '';
      let i = 0;
      const total = slides.length;

      const stage = el('div', {className:'slide'});
      const media = el('div', {className:'media'});
      const copy  = el('div', {className:'copy'});
      const title = el('h3');
      const text  = el('p');
      copy.append(title, text);
      stage.append(media, copy);

      const controls = el('nav', {className:'controls'});
      const back = el('button', {className:'btn ghost', textContent:'← Back'});
      const next = el('button', {className:'btn primary', textContent:'Next →'});
      const step = el('div', {className:'step'});
      const dot  = el('span', {className:'dot', style:'width:8px;height:8px;border-radius:50%;background:var(--primary)'});
      const stepTxt = el('span', {textContent:`Step 1 of ${total}`});
      step.append(dot, stepTxt);
      controls.append(back, step, next);

      const wrap = el('div', {className:'journey'});
      wrap.append(stage, controls);
      journey.append(wrap);

      function show(idx){
        const s = slides[idx];
        media.innerHTML='';
        if(s.img){ const img = new Image(); img.src = s.img; img.alt = s.title || 'Photo'; media.append(img); }
        else { media.innerHTML = `<div style="width:100%;height:100%;display:grid;place-items:center;color:#6b6b6b">No image</div>`; }
        title.textContent = s.title || '';
        text.textContent  = s.text || '';
        stepTxt.textContent = `Step ${idx+1} of ${total}`;
        back.disabled = idx===0; next.textContent = idx===total-1 ? 'Finish ❤️' : 'Next →';
        stage.classList.add('fade-in'); setTimeout(()=>stage.classList.remove('fade-in'), 400);
      }

      back.onclick = ()=>{ if(i>0){ i--; show(i);} };
      next.onclick = ()=>{ if(i<total-1){ i++; show(i);} else { goodbye(); } };

      function goodbye(){
        journey.innerHTML = `<div class="welcome view active" style="text-align:center;padding:40px">
          <h2 style="color:var(--primary)">Thank you for being you ✨</h2>
          <p>Happy Birthday, Line. Always.</p>
          <button class="btn ghost" id="restart">Back to start</button>
        </div>`;
        document.getElementById('restart').onclick = ()=>{ swap(welcome); };
      }

      show(i);
    }

    // -------------------- Admin encryptor --------------------
    (function(){
      const url = new URL(location.href);
      if(url.searchParams.get('admin') === '1'){
        const panel = document.getElementById('admin');
        panel.classList.add('active');
        document.getElementById('doEncrypt').onclick = async ()=>{
          const json = document.getElementById('plainJson').value.trim();
          const pw   = document.getElementById('adminPw').value.trim();
          if(!json || !pw){ alert('Enter JSON and password'); return; }
          try{
            // Validate JSON
            JSON.parse(json);
            const b64 = await encryptJSON(json, pw);
            document.getElementById('outCipher').value = b64;
          }catch(e){ alert('Invalid JSON or encryption error: '+ e.message); }
        };
      }
    })();
  </script>
</body>
</html>
